<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Deezster Ultimate</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- 1. DESIGN SYSTEM --- */
        :root {
            --primary: #FF3CAC;
            --secondary: #784BA0;
            --accent: #2B86C5;
            --glass-bg: rgba(20, 20, 20, 0.6);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --glass-highlight: rgba(255, 255, 255, 0.1);
            --font-stack: 'SF Pro Display', -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: var(--font-stack); -webkit-tap-highlight-color: transparent; }

        body {
            background-color: #000;
            background-image: linear-gradient(225deg, #FF3CAC 0%, #784BA0 50%, #2B86C5 100%);
            background-size: 200% 200%;
            animation: moveGradient 15s ease infinite;
            color: white;
            height: 100vh; width: 100vw;
            overflow: hidden;
            display: flex; justify-content: center;
        }

        @keyframes moveGradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        /* APP FRAME */
        .app-frame {
            width: 100%; max-width: 500px; height: 100%;
            background: rgba(0,0,0,0.3); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            display: flex; flex-direction: column; position: relative;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        /* HEADER */
        header {
            padding: 15px 20px;
            padding-top: max(15px, var(--safe-area-top));
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.2);
            z-index: 10;
        }
        .brand { font-size: 1.5rem; font-weight: 900; letter-spacing: -0.5px; }
        .brand span { color: #5edfff; }
        .lives-pill { background: rgba(255,255,255,0.15); padding: 5px 12px; border-radius: 20px; font-size: 0.9rem; font-weight: bold; }

        /* NAVIGATION SCREENS */
        .screen {
            flex: 1; display: flex; flex-direction: column;
            overflow: hidden; /* Wichtig f√ºr interne Scrollbars */
            position: absolute; top: 60px; bottom: 0; width: 100%;
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0; transform: translateX(20px); pointer-events: none;
            padding-bottom: var(--safe-area-bottom);
        }
        .screen.active { opacity: 1; transform: translateX(0); pointer-events: all; z-index: 5; position: relative; top: 0; }

        /* SCROLL AREAS */
        .scroll-content {
            flex: 1; overflow-y: auto; padding: 20px;
            -webkit-overflow-scrolling: touch;
        }

        /* UI ELEMENTS */
        .search-bar { padding: 0 20px 10px 20px; display: flex; gap: 10px; }
        input {
            flex: 1; background: rgba(255,255,255,0.1); border: var(--glass-border);
            border-radius: 12px; padding: 12px; color: white; outline: none; font-size: 1rem;
        }
        .btn {
            background: rgba(255,255,255,0.2); border: none; color: white;
            border-radius: 12px; padding: 0 15px; cursor: pointer; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
        }
        .btn:active { background: rgba(255,255,255,0.4); transform: scale(0.96); }
        .btn-primary { background: white; color: black; }
        .btn-icon { width: 44px; padding: 0; font-size: 1.2rem; }

        /* PLAYLIST ITEMS */
        .playlist-card {
            display: flex; align-items: center; gap: 15px;
            background: rgba(255,255,255,0.05); border-radius: 16px;
            padding: 10px; margin-bottom: 10px; cursor: pointer;
            transition: background 0.2s;
        }
        .playlist-card:active { background: rgba(255,255,255,0.15); }
        .playlist-img { width: 60px; height: 60px; border-radius: 10px; object-fit: cover; }

        /* HERO PLAYLIST */
        .hero-playlist {
            background: linear-gradient(180deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.05) 100%);
            border-radius: 20px; padding: 20px; text-align: center; margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .hero-img { width: 150px; height: 150px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }

        /* MODE GRID */
        .mode-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .mode-tile {
            background: rgba(255,255,255,0.1); border-radius: 16px; padding: 20px 10px;
            text-align: center; cursor: pointer; border: 1px solid transparent;
        }
        .mode-tile:active { background: rgba(255,255,255,0.2); }
        .mode-tile i { font-size: 2rem; margin-bottom: 10px; display: block; }
        .mode-tile h4 { margin: 0; font-size: 0.9rem; }
        .mode-tile p { margin: 5px 0 0 0; font-size: 0.7rem; opacity: 0.7; }

        /* GAME UI */
        .vinyl-container {
            width: 140px; height: 140px; margin: 10px auto; position: relative;
            flex-shrink: 0;
        }
        .vinyl {
            width: 100%; height: 100%; background: radial-gradient(#222, #000);
            border-radius: 50%; border: 4px solid #111;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .vinyl-label {
            width: 35%; height: 35%; background: var(--primary);
            border-radius: 50%; border: 2px solid white; background-size: cover;
        }
        .spinning { animation: spin 4s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* TIMELINE */
        .timeline-wrapper { display: flex; flex-direction: column; gap: 10px; padding-bottom: 40px; }
        .tl-card {
            background: white; color: black; padding: 12px; border-radius: 12px;
            display: flex; align-items: center; gap: 12px;
        }
        .tl-year { font-weight: 900; font-size: 1.2rem; color: var(--primary); }
        .insert-zone {
            border: 2px dashed rgba(255,255,255,0.3); border-radius: 12px;
            padding: 12px; text-align: center; font-size: 0.8rem; font-weight: bold;
            color: rgba(255,255,255,0.7); cursor: pointer;
        }
        .insert-zone:active { background: rgba(255,255,255,0.1); border-color: white; color: white; }

        /* QUIZ GRID */
        .quiz-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: auto; }
        .quiz-btn {
            background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.1);
            padding: 15px 5px; border-radius: 12px; font-size: 0.85rem; font-weight: 600;
            min-height: 80px; display: flex; align-items: center; justify-content: center;
            line-height: 1.2; text-align: center;
        }
        .correct { background: #2ecc71 !important; color: white !important; border-color: white !important; }
        .wrong { background: #e74c3c !important; color: white !important; }

        /* UTILS */
        .hidden { display: none !important; }
        .overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.9); z-index: 50;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .overlay.visible { opacity: 1; pointer-events: all; }
        .spinner {
            width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1);
            border-top: 4px solid white; border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        .timer-bar { height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; overflow: hidden; margin: 10px 20px; }
        .timer-fill { height: 100%; background: #2ecc71; width: 100%; transform-origin: left; }
        .anim-timer { animation: shrink 30s linear forwards; }
        @keyframes shrink { 0% { transform: scaleX(1); background: #2ecc71; } 100% { transform: scaleX(0); background: #e74c3c; } }

        .blur-img { width: 200px; height: 200px; border-radius: 12px; filter: blur(30px); margin: 0 auto; display: block; object-fit: cover; }
        .anim-unblur { animation: unblur 20s linear forwards; }
        @keyframes unblur { to { filter: blur(0px); } }

    </style>
</head>
<body>

<div class="app-frame">

    <header>
        <div class="brand">Deez<span>ster</span></div>
        <div class="lives-pill" id="header-status">
            Willkommen
        </div>
    </header>

    <div id="screen-home" class="screen active">
        <div class="search-bar">
            <input type="text" id="search-input" placeholder="Playlist suchen...">
            <button class="btn btn-primary btn-icon" onclick="searchPlaylists()"><i class="fas fa-search"></i></button>
        </div>

        <div class="scroll-content" id="home-content">
            <div class="hero-playlist" onclick="selectPlaylist('14834933783', 'Die geile Mische')">
                <img src="https://e-cdns-images.dzcdn.net/images/playlist/372702759e693b7df044c32b57020022/500x500-000000-80-0-0.jpg" class="hero-img">
                <h2>Die geile Mische</h2>
                <p>Empfohlene Playlist</p>
                <div class="btn btn-primary" style="margin-top:10px;">Jetzt spielen</div>
            </div>

            <h3 style="margin-left: 5px;">Suchergebnisse</h3>
            <div id="playlist-results">
                <div class="playlist-card" onclick="selectPlaylist('1363560485', 'Best of 80s')">
                    <img src="https://e-cdns-images.dzcdn.net/images/playlist/73252538cb1235b2210a693c061d4b68/250x250-000000-80-0-0.jpg" class="playlist-img">
                    <div>
                        <div style="font-weight:bold">Best of 80s</div>
                        <div style="font-size:0.8rem; opacity:0.7;">Klassiker</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-modes" class="screen">
        <div class="scroll-content">
            <h2 id="mode-playlist-title" style="margin-bottom:5px; color:#5edfff;">Playlist</h2>
            <p style="margin-bottom:20px;">W√§hle deinen Modus:</p>

            <div class="mode-grid">
                <div class="mode-tile" onclick="setupGame('timeline')" style="border-color:#3498db"><i class="fas fa-stream" style="color:#3498db"></i><h4>Timeline</h4><p>Ordne die Jahre</p></div>
                <div class="mode-tile" onclick="setupGame('quiz')" style="border-color:#f1c40f"><i class="fas fa-bolt" style="color:#f1c40f"></i><h4>Quiz</h4><p>Highscore Jagd</p></div>
                <div class="mode-tile" onclick="setupGame('hl')" style="border-color:#e67e22"><i class="fas fa-arrows-alt-v" style="color:#e67e22"></i><h4>High/Low</h4><p>√Ñlter oder Neuer?</p></div>
                <div class="mode-tile" onclick="setupGame('onesec')" style="border-color:#e74c3c"><i class="fas fa-stopwatch" style="color:#e74c3c"></i><h4>1 Sekunde</h4><p>Erkennst du es?</p></div>
                <div class="mode-tile" onclick="setupGame('blur')" style="border-color:#9b59b6"><i class="fas fa-image" style="color:#9b59b6"></i><h4>Blur</h4><p>Cover raten</p></div>
                <div class="mode-tile" onclick="setupGame('duel')" style="border-color:#2ecc71"><i class="fas fa-user-friends" style="color:#2ecc71"></i><h4>Duell</h4><p>1 vs 1 Lokal</p></div>
            </div>

            <button class="btn btn-secondary" style="width:100%; margin-top:30px; padding:15px;" onclick="goHome()">Andere Playlist w√§hlen</button>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div style="padding: 0 20px; flex-shrink: 0;">
             <button class="btn" style="background:rgba(255,255,255,0.1); width:100%; margin-bottom:10px; font-size:0.8rem;" onclick="exitGame()">Spiel beenden</button>
        </div>

        <div id="game-content" class="scroll-content" style="display:flex; flex-direction:column;">
            </div>
    </div>

    <div id="overlay-load" class="overlay">
        <div class="spinner"></div>
        <h3>Lade Musik...</h3>
    </div>

    <div id="overlay-end" class="overlay">
        <h1 id="end-title" style="font-size:3rem; margin-bottom:10px;">Game Over</h1>
        <p id="end-msg" style="font-size:1.2rem; opacity:0.8;">Score: 0</p>
        <div style="display:flex; gap:10px; margin-top:30px;">
            <button class="btn btn-secondary" onclick="exitGame()">Men√º</button>
            <button class="btn btn-primary" onclick="restartGame()">Nochmal</button>
        </div>
    </div>

    <audio id="audio-player"></audio>
</div>

<script>
    /* ================= SYSTEM CORE ================= */
    const state = {
        playlistId: null, tracks: [], pool: [], currentTrack: null, nextTrack: null, isPlaying: false,
        mode: null, score: 0, lives: 3, startTime: 0,
        timeline: [], targetScore: 10, hlStreak: 0, secLevel: 1, duelP1: 0, duelP2: 0
    };

    const els = {
        audio: document.getElementById('audio-player'),
        gameCon: document.getElementById('game-content'),
        status: document.getElementById('header-status'),
        results: document.getElementById('playlist-results')
    };

    // --- API HELPER (Deezer JSONP) ---
    function fetchDeezer(url) {
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            const cb = 'dz_' + Math.round(Math.random() * 1000000);
            window[cb] = (d) => { delete window[cb]; document.body.removeChild(script); resolve(d); };
            script.src = url + (url.includes('?') ? '&' : '?') + 'output=jsonp&callback=' + cb;
            script.onerror = () => reject();
            document.body.appendChild(script);
        });
    }

    // --- ISRC FIX (Remaster Detection) ---
    function getYearFromISRC(isrc) {
        if (!isrc || isrc.length < 7) return null;
        const yy = parseInt(isrc.substring(5, 7));
        return isNaN(yy) ? null : ((yy > (new Date().getFullYear() % 100) + 1) ? 1900 + yy : 2000 + yy);
    }

    async function getSongDetails(track) {
        try {
            // Parallel fetch for speed
            const [alb, tDetails] = await Promise.all([
                fetchDeezer(`https://api.deezer.com/album/${track.album.id}`),
                track.isrc ? Promise.resolve(track) : fetchDeezer(`https://api.deezer.com/track/${track.id}`)
            ]);

            let year = parseInt(alb.release_date.split('-')[0]);
            const isrcYear = getYearFromISRC(tDetails.isrc);

            // Logik: ISRC bevorzugen wenn √§lter
            if(isrcYear && isrcYear < year && isrcYear > 1900) year = isrcYear;
            if(isNaN(year) || year < 1900 || year > 2030) return null;

            return {
                ...track, year,
                cover: track.album.cover_xl,
                cover_med: track.album.cover_medium,
                title_clean: track.title.replace(/\(.*\)/g, "").trim() // Cleaner title for quiz
            };
        } catch(e) { return null; }
    }

    async function getValidSong() {
        while(state.pool.length > 0) {
            const raw = state.pool.pop();
            const song = await getSongDetails(raw);
            if(song) return song;
        }
        return null;
    }

    // --- NAVIGATION ---
    function navigate(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
    }
    function goHome() { navigate('screen-home'); stopAudio(); }
    function loader(show) { document.getElementById('overlay-load').className = show ? 'overlay visible' : 'overlay'; }

    // --- PLAYLIST LOGIC ---
    async function searchPlaylists() {
        const q = document.getElementById('search-input').value;
        if(!q) return;
        els.results.innerHTML = '<p style="text-align:center; opacity:0.5;">Suche...</p>';
        try {
            const d = await fetchDeezer(`https://api.deezer.com/search/playlist?q=${encodeURIComponent(q)}`);
            els.results.innerHTML = d.data.map(p =>
                `<div class="playlist-card" onclick="selectPlaylist('${p.id}', '${p.title.replace(/'/g,"")}')">
                    <img src="${p.picture_medium}" class="playlist-img">
                    <div><div style="font-weight:bold;">${p.title}</div><div style="font-size:0.8rem; opacity:0.7;">${p.nb_tracks} Songs</div></div>
                </div>`
            ).join('');
        } catch(e) { els.results.innerHTML = 'Fehler.'; }
    }

    async function selectPlaylist(id, name) {
        loader(true);
        try {
            const d = await fetchDeezer(`https://api.deezer.com/playlist/${id}/tracks?limit=500`);
            state.tracks = d.data.filter(t => t.preview && t.album);
            if(state.tracks.length < 15) throw new Error("Playlist zu klein (min. 15 Songs)");
            state.pool = [...state.tracks].sort(() => 0.5 - Math.random());

            document.getElementById('mode-playlist-title').innerText = name;
            loader(false);
            navigate('screen-modes');
        } catch(e) {
            loader(false); alert("Fehler: " + e.message);
        }
    }

    // --- AUDIO ---
    function audioCtrl(play, url=null) {
        if(play && url) { els.audio.src = url; els.audio.play().catch(e=>{}); state.isPlaying=true; }
        else { els.audio.pause(); state.isPlaying=false; }

        const v = document.querySelector('.vinyl');
        if(v) state.isPlaying ? v.classList.add('spinning') : v.classList.remove('spinning');

        // Update Play Button Icon globally inside game content
        const btn = document.getElementById('play-toggle-btn');
        if(btn) btn.innerHTML = state.isPlaying ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>';
    }

    // --- GAME SETUP ---
    function setupGame(mode) {
        state.mode = mode; state.score = 0; state.lives = 3;
        state.duelP1 = 0; state.duelP2 = 0;
        updateStatus();
        navigate('screen-game');

        if(mode === 'timeline') initTimeline();
        else if(mode === 'quiz') initQuiz();
        else if(mode === 'hl') initHL();
        else if(mode === 'onesec') initOneSec();
        else if(mode === 'blur') initBlur();
        else if(mode === 'duel') initDuel();
    }
    function restartGame() {
        document.getElementById('overlay-end').classList.remove('visible');
        setupGame(state.mode);
    }
    function exitGame() {
        stopAudio();
        document.getElementById('overlay-end').classList.remove('visible');
        navigate('screen-modes');
    }
    function updateStatus() {
        if(state.mode === 'quiz' || state.mode === 'onesec' || state.mode === 'blur') els.status.innerHTML = `Score: ${state.score}`;
        else if(state.mode === 'duel') els.status.innerHTML = `P1: ${state.duelP1} | P2: ${state.duelP2}`;
        else els.status.innerHTML = "‚ù§Ô∏è".repeat(state.lives);
    }
    function stopAudio() { audioCtrl(false); }

    /* ================= GAME MODES ================= */

    /* 1. TIMELINE */
    async function initTimeline() {
        state.timeline = []; state.targetScore = 10;
        loader(true);
        const start = await getValidSong();
        state.timeline.push(start);
        nextTimeline();
    }
    async function nextTimeline() {
        const song = await getValidSong();
        if(!song) return endGame(true, "Playlist leer!");
        state.currentTrack = song;
        loader(false);
        renderTimelineUI();
        audioCtrl(true, song.preview);
    }
    function renderTimelineUI() {
        let html = `
            <div style="text-align:center; margin-bottom:20px;">
                <div class="vinyl-container"><div class="vinyl"><div class="vinyl-label" style="background-image:url(${state.currentTrack.cover_med})"></div></div></div>
                <button id="play-toggle-btn" class="btn btn-primary" onclick="audioCtrl(!state.isPlaying, '${state.currentTrack.preview}')"><i class="fas fa-pause"></i></button>
                <p style="margin-top:10px; font-size:0.9rem;">Wo passt dieser Song hin?</p>
            </div>
            <div class="timeline-wrapper">`;

        html += `<div class="insert-zone" onclick="checkTimeline(0)">Hier (√Ñlter als ${state.timeline[0].year})</div>`;
        state.timeline.forEach((s, i) => {
            html += `<div class="tl-card">
                <div class="tl-year">${s.year}</div>
                <div style="text-align:left; font-size:0.85rem; line-height:1.2;">
                    <div>${s.title_clean}</div><div style="opacity:0.7; font-size:0.75rem;">${s.artist.name}</div>
                </div>
            </div>`;
            if(i < state.timeline.length) html += `<div class="insert-zone" onclick="checkTimeline(${i+1})">Hier</div>`;
        });
        html += `</div>`;
        els.gameCon.innerHTML = html;
    }
    function checkTimeline(i) {
        audioCtrl(false);
        const y = state.currentTrack.year;
        const prev = state.timeline[i-1]; const next = state.timeline[i];

        if((prev && y < prev.year) || (next && y > next.year)) {
            state.lives--; updateStatus();
            alert(`Falsch! Es war ${y}.`);
            if(state.lives <= 0) endGame(false, "Keine Leben mehr");
            else { loader(true); nextTimeline(); }
        } else {
            state.timeline.splice(i, 0, state.currentTrack);
            if(state.timeline.length >= state.targetScore) endGame(true, "Ziel erreicht!");
            else { loader(true); nextTimeline(); }
        }
    }

    /* 2. QUIZ (HIGHSCORE) - MIT DUPLICATE FIX */
    async function initQuiz() { nextQuiz(); }
    async function nextQuiz() {
        loader(true);
        const target = await getValidSong();
        if(!target) return endGame(true, `Score: ${state.score}`);

        // Fix: Duplikate bei Titeln vermeiden
        const decoys = [];
        let safeCounter = 0;
        while(decoys.length < 3 && safeCounter < 50) {
            safeCounter++;
            const d = state.pool[Math.floor(Math.random() * state.pool.length)];
            // Pr√ºfen ob Titel schon existiert (Target oder Decoy)
            const titleExists = d.title.trim() === target.title.trim() || decoys.some(x => x.title.trim() === d.title.trim());
            if(d.id !== target.id && !titleExists) decoys.push(d);
        }

        if(decoys.length < 3) return endGame(true, "Nicht genug eindeutige Songs.");

        state.currentTrack = target;
        const options = [target, ...decoys].sort(()=>0.5-Math.random());
        loader(false);

        els.gameCon.innerHTML = `
            <div class="timer-bar"><div class="timer-fill anim-timer"></div></div>
            <div class="vinyl-container"><div class="vinyl"><div class="vinyl-label" style="background:#333;"></div></div></div>
            <div class="quiz-grid">
                ${options.map(o => `<div class="quiz-btn" onclick="checkQuiz(this, ${o.id===target.id})">${o.title_clean}</div>`).join('')}
            </div>`;

        audioCtrl(true, target.preview);
        state.startTime = Date.now();
    }
    function checkQuiz(el, correct) {
        audioCtrl(false);
        document.querySelector('.timer-fill').style.animationPlayState = 'paused';
        document.querySelector('.vinyl-label').style.backgroundImage = `url(${state.currentTrack.cover})`;

        if(correct) {
            el.classList.add('correct');
            const pts = Math.max(100, 1000 - Math.floor((Date.now()-state.startTime)/30));
            state.score += pts; updateStatus();
            setTimeout(nextQuiz, 1000);
        } else {
            el.classList.add('wrong');
            setTimeout(() => endGame(false, `Final Score: ${state.score}`), 1500);
        }
    }

    /* 3. HIGH / LOW */
    async function initHL() { state.hlStreak = 0; loader(true); state.currentTrack = await getValidSong(); nextHL(); }
    async function nextHL() {
        state.nextTrack = await getValidSong();
        if(!state.nextTrack) return endGame(true, `Streak: ${state.hlStreak}`);
        loader(false);
        els.gameCon.innerHTML = `
            <div style="text-align:center; margin-top:20px;">
                <div class="tl-card" style="margin-bottom:20px; justify-content:center;">
                    <div class="tl-year">${state.currentTrack.year}</div>
                    <div style="text-align:left; font-size:0.9rem;">${state.currentTrack.title_clean}</div>
                </div>
                <h3 style="margin:30px 0;">Ist der Song √Ñlter oder Neuer?</h3>
                <div class="vinyl-container"><div class="vinyl"><div class="vinyl-label" style="background:#333;"></div></div></div>
                <div style="display:flex; gap:15px; margin-top:20px;">
                    <button class="btn btn-danger" style="flex:1; padding:20px;" onclick="checkHL('older')">√ÑLTER üîΩ</button>
                    <button class="btn btn-success" style="flex:1; padding:20px;" onclick="checkHL('newer')">NEUER üîº</button>
                </div>
            </div>`;
        audioCtrl(true, state.nextTrack.preview);
    }
    function checkHL(guess) {
        audioCtrl(false);
        const ref = state.currentTrack.year; const target = state.nextTrack.year;
        document.querySelector('.vinyl-label').style.backgroundImage = `url(${state.nextTrack.cover})`;

        const win = (guess === 'older' && target < ref) || (guess === 'newer' && target > ref) || target === ref;

        if(win) {
            state.hlStreak++; alert(`Richtig! (${target})`);
            state.currentTrack = state.nextTrack;
            loader(true); nextHL();
        } else {
            state.lives--; updateStatus(); alert(`Falsch! (${target})`);
            if(state.lives<=0) endGame(false, `Streak: ${state.hlStreak}`);
            else { loader(true); nextHL(); }
        }
    }

    /* 4. 1-SECOND CHALLENGE */
    async function initOneSec() { updateStatus(); nextOneSec(); }
    async function nextOneSec() {
        loader(true);
        const target = await getValidSong();
        if(!target) return endGame(true, `Score: ${state.score}`);

        // Decoys
        const decoys = [];
        let safeCounter = 0;
        while(decoys.length < 3 && safeCounter < 50) {
            safeCounter++;
            const d = state.pool[Math.floor(Math.random() * state.pool.length)];
            const titleExists = d.title.trim() === target.title.trim() || decoys.some(x => x.title.trim() === d.title.trim());
            if(d.id !== target.id && !titleExists) decoys.push(d);
        }
        state.currentTrack = target; state.secLevel = 1;
        const options = [target, ...decoys].sort(()=>0.5-Math.random());
        loader(false);

        els.gameCon.innerHTML = `
            <div class="vinyl-container"><div class="vinyl"><div class="vinyl-label" style="background:#333;"></div></div></div>
            <div style="display:flex; gap:10px; justify-content:center; margin:10px 0;">
                <button class="btn btn-primary" onclick="playSnippet(1000)">1 Sekunde</button>
                <button class="btn btn-warn" onclick="playSnippet(3000); state.secLevel=3;">+3s (-500 Pkt)</button>
            </div>
            <div class="quiz-grid">
                ${options.map(o => `<div class="quiz-btn" onclick="checkOneSec(this, ${o.id===target.id})">${o.title_clean}</div>`).join('')}
            </div>`;
        playSnippet(1000);
    }
    function playSnippet(ms) {
        audioCtrl(false); els.audio.src = state.currentTrack.preview; els.audio.currentTime = 0;
        els.audio.play(); document.querySelector('.vinyl').classList.add('spinning');
        setTimeout(() => audioCtrl(false), ms);
    }
    function checkOneSec(el, correct) {
        document.querySelector('.vinyl-label').style.backgroundImage = `url(${state.currentTrack.cover})`;
        if(correct) {
            const pts = state.secLevel === 1 ? 1000 : 500;
            state.score += pts; updateStatus(); el.classList.add('correct');
            setTimeout(nextOneSec, 1500);
        } else {
            el.classList.add('wrong');
            setTimeout(() => endGame(false, `Final Score: ${state.score}`), 1500);
        }
    }

    /* 5. COVER BLUR - MIT DUPLICATE FIX (ARTIST) */
    async function initBlur() { nextBlur(); }
    async function nextBlur() {
        loader(true);
        const target = await getValidSong();

        // Fix: Duplikate bei Artists vermeiden
        const decoys = [];
        let safeCounter = 0;
        while(decoys.length < 3 && safeCounter < 50) {
            safeCounter++;
            const d = state.pool[Math.floor(Math.random() * state.pool.length)];
            const nameExists = d.artist.name === target.artist.name || decoys.some(x => x.artist.name === d.artist.name);
            if(d.id !== target.id && !nameExists) decoys.push(d);
        }

        state.currentTrack = target;
        const options = [target, ...decoys].sort(()=>0.5-Math.random());
        loader(false);

        els.gameCon.innerHTML = `
            <img src="${target.cover}" class="blur-img anim-unblur">
            <p style="text-align:center; margin-top:10px;">Wer ist das?</p>
            <div class="quiz-grid">
                ${options.map(o => `<div class="quiz-btn" onclick="checkBlur(this, ${o.id===target.id})">${o.artist.name}</div>`).join('')}
            </div>`;
        audioCtrl(true, target.preview);
        state.startTime = Date.now();
    }
    function checkBlur(el, correct) {
        audioCtrl(false);
        document.querySelector('.blur-img').style.filter = 'blur(0px)';
        if(correct) {
            const pts = Math.max(100, 1000 - Math.floor((Date.now()-state.startTime)/20));
            state.score += pts; updateStatus(); el.classList.add('correct');
            setTimeout(nextBlur, 1500);
        } else {
            el.classList.add('wrong');
            setTimeout(() => endGame(false, `Score: ${state.score}`), 1500);
        }
    }

    /* 6. PARTY DUEL */
    async function initDuel() { updateStatus(); nextDuel(); }
    async function nextDuel() {
        loader(true);
        state.currentTrack = await getValidSong();
        loader(false);
        els.gameCon.innerHTML = `
            <div style="text-align:center;">
                <div class="vinyl-container"><div class="vinyl"><div class="vinyl-label" style="background:#333;"></div></div></div>
                <button id="play-toggle-btn" class="btn btn-primary" onclick="audioCtrl(!state.isPlaying, '${state.currentTrack.preview}')"><i class="fas fa-play"></i></button>
            </div>
            <div style="margin-top:20px; padding:0 20px;">
                <p>Spieler 1 Tipp:</p><input type="number" id="p1-in" placeholder="Jahr">
                <p style="margin-top:10px;">Spieler 2 Tipp:</p><input type="number" id="p2-in" placeholder="Jahr">
                <button class="btn btn-success" style="width:100%; margin-top:20px;" onclick="resolveDuel()">Aufl√∂sen</button>
            </div>`;
    }
    function resolveDuel() {
        const p1 = parseInt(document.getElementById('p1-in').value);
        const p2 = parseInt(document.getElementById('p2-in').value);
        if(!p1 || !p2) return alert("Beide tippen!");

        audioCtrl(false);
        const real = state.currentTrack.year;
        document.querySelector('.vinyl-label').style.backgroundImage = `url(${state.currentTrack.cover})`;

        const d1 = Math.abs(real-p1); const d2 = Math.abs(real-p2);
        if(d1 < d2) { state.duelP1++; alert(`P1 gewinnt! (${real})`); }
        else if(d2 < d1) { state.duelP2++; alert(`P2 gewinnt! (${real})`); }
        else alert(`Unentschieden! (${real})`);

        updateStatus();
        nextDuel();
    }

    /* --- GAME OVER --- */
    function endGame(win, msg) {
        audioCtrl(false);
        document.getElementById('end-title').innerText = win ? "Sieg!" : "Game Over";
        document.getElementById('end-msg').innerText = msg;
        document.getElementById('overlay-end').classList.add('visible');
    }

</script>
</body>
</html>
