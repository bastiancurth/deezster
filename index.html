<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Deezster 2.3 - Stable</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- DESIGN (Premium Glass) --- */
        :root {
            --primary: #23a6d5;
            --secondary: #e73c7e;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: 1px solid rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }

        body {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%; animation: gradientBG 15s ease infinite;
            color: white; min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 10px;
        }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .app-container {
            width: 100%; max-width: 600px;
            background: var(--glass-bg); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: var(--glass-border); border-radius: 24px; box-shadow: var(--glass-shadow);
            padding: 20px; text-align: center; position: relative; overflow: hidden;
            display: flex; flex-direction: column; max-height: 90vh;
        }

        h1 { font-size: 2rem; font-weight: 800; text-shadow: 0 0 10px rgba(0,0,0,0.2); margin-bottom: 5px; }
        h1 span { text-shadow: 0 0 15px var(--primary); }
        h3 { margin-bottom: 15px; opacity: 0.9; }

        input {
            width: 100%; padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.3);
            background: rgba(0,0,0,0.2); color: white; font-size: 1rem; margin-bottom: 10px; outline: none; text-align: center;
        }
        .btn {
            width: 100%; padding: 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2);
            font-size: 1rem; font-weight: 700; cursor: pointer; transition: all 0.2s;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 8px;
        }
        .btn-primary { background: rgba(255, 255, 255, 0.25); color: white; }
        .btn-primary:active { transform: scale(0.98); background: rgba(255, 255, 255, 0.4); }
        .btn-secondary { background: rgba(0, 0, 0, 0.3); color: white; }
        .btn-danger { background: rgba(231, 76, 60, 0.8) !important; color: white; border-color: red !important; }
        .btn-success { background: rgba(46, 204, 113, 0.8) !important; color: white; border-color: green !important; }

        /* Listen & Karten */
        #playlist-list { max-height: 250px; overflow-y: auto; margin-top: 10px; }
        .playlist-item {
            display: flex; align-items: center; background: rgba(255,255,255,0.1);
            padding: 8px; margin-bottom: 6px; border-radius: 8px; cursor: pointer;
        }
        .playlist-item img { width: 40px; height: 40px; border-radius: 6px; margin-right: 10px; }
        .playlist-info { text-align: left; }

        /* Vinyl */
        .vinyl-wrapper-sm { width: 100px; height: 100px; margin: 10px auto; position: relative; }
        .vinyl {
            width: 100%; height: 100%; background: radial-gradient(#333, #111);
            border-radius: 50%; border: 2px solid #111; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .vinyl-label { width: 40%; height: 40%; background: var(--primary); border-radius: 50%; border: 2px solid white; background-size: cover; }
        .spinning { animation: spin 4s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Timer */
        .timer-container { width: 100%; height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; margin: 10px 0; overflow: hidden; }
        .timer-bar { height: 100%; width: 100%; background: #2ecc71; transform-origin: left; }
        .animate-timer { animation: shrink 30s linear forwards; }
        @keyframes shrink { 0% { transform: scaleX(1); background:#2ecc71; } 50% { background:#f1c40f; } 100% { transform: scaleX(0); background:#e74c3c; } }

        /* Timeline Specifics */
        .timeline-container {
            display: flex; flex-direction: column; gap: 8px; overflow-y: auto; max-height: 55vh; padding: 10px 5px;
            background: rgba(0,0,0,0.15); border-radius: 12px; margin-top: 10px;
        }
        .timeline-card {
            background: white; color: black; padding: 10px; border-radius: 8px;
            display: flex; align-items: center; gap: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .insert-btn {
            background: rgba(255,255,255,0.15); border: 2px dashed rgba(255,255,255,0.3);
            color: white; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: bold;
            transition: all 0.1s; text-transform: uppercase; letter-spacing: 1px;
        }
        .insert-btn:active { background: rgba(255,255,255,0.4); transform: scale(0.98); }

        /* MC Grid */
        .mc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .mc-btn { height: 75px; font-size: 0.85rem; white-space: normal; line-height: 1.2; padding: 5px; }

        /* Overlays */
        .hidden { display: none !important; }
        .modal-overlay {
            position: absolute; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.9);
            display: flex; align-items: center; justify-content: center; z-index: 20; flex-direction: column;
            backdrop-filter: blur(5px);
        }
        .score-change {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 3rem; font-weight: bold; color: #2ecc71; text-shadow: 0 0 20px black;
            animation: floatUp 1s forwards; pointer-events: none; z-index: 100;
        }
        @keyframes floatUp { to { transform: translate(-50%, -150%); opacity: 0; } }
        .spinner { border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid #fff; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
    </style>
</head>
<body>

    <div class="app-container">
        <header><h1>Deez<span>ster</span></h1></header>

        <div id="screen-search">
            <p>W√§hle eine Playlist:</p>
            <input type="text" id="search-input" placeholder="Suche (z.B. 80s, Rock)...">
            <button id="search-btn" class="btn btn-primary">Suchen</button>
            <div id="playlist-list">
                <div class="playlist-item" onclick="selectPlaylist('3155776842', '100% Hits')">
                    <img src="https://e-cdns-images.dzcdn.net/images/playlist/89f6dfc009b0b43d2c0024440f340864/250x250-000000-80-0-0.jpg">
                    <div class="playlist-info"><h4>100% Hits</h4><span>Mix</span></div>
                </div>
            </div>
        </div>

        <div id="screen-mode" class="hidden">
            <h3 id="selected-playlist-name">Playlist</h3>
            <div style="display: grid; gap: 15px;">
                <button class="btn btn-primary" onclick="setupGame('mc')" style="height: 80px; font-size: 1.2rem;">
                    <i class="fas fa-bolt"></i> Highscore Jagd<br><span style="font-size:0.8rem; font-weight:normal; display:block; margin-top:5px;">Ein Fehler = Game Over!</span>
                </button>
                <button class="btn btn-primary" onclick="setupGame('timeline')" style="height: 80px; font-size: 1.2rem;">
                    <i class="fas fa-stream"></i> Timeline (Ordnen)<br><span style="font-size:0.8rem; font-weight:normal; display:block; margin-top:5px;">Sortiere die Jahre (3 Leben)</span>
                </button>
            </div>

            <div id="timeline-settings" class="hidden" style="margin-top:20px; border-top:1px solid rgba(255,255,255,0.2); padding-top:10px;">
                <p>Karten zum Sieg:</p>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-secondary" onclick="startTimeline(10)">10</button>
                    <button class="btn btn-secondary" onclick="startTimeline(15)">15</button>
                </div>
            </div>
            <button class="btn btn-secondary" onclick="showScreen('screen-search')" style="margin-top:20px;">Zur√ºck</button>
        </div>

        <div id="screen-game-timeline" class="hidden">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <div>Ziel: <span id="tl-target">10</span></div>
                <div id="tl-lives" style="letter-spacing: 3px;">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
            </div>

            <div style="display:flex; align-items:center; gap:10px; background:rgba(0,0,0,0.2); padding:8px; border-radius:12px; margin-bottom:10px;">
                <div class="vinyl-wrapper-sm" style="width:40px; height:40px; margin:0;"><div class="vinyl" id="tl-vinyl"><div class="vinyl-label"></div></div></div>
                <div style="flex-grow:1; text-align:left; font-size:0.85rem; opacity:0.8;">H√∂r dir den Song an...</div>
                <button id="tl-play-btn" class="btn btn-primary" style="flex-grow:0; width:auto; padding:8px 12px; margin:0;"><i class="fas fa-play"></i></button>
            </div>

            <div id="timeline-area" class="timeline-container">
                </div>
        </div>

        <div id="screen-game-mc" class="hidden">
            <div style="font-size: 1.5rem; font-weight: bold; margin-bottom: 5px;">
                Score: <span id="mc-score" style="color:var(--primary)">0</span>
            </div>
            <div class="timer-container"><div id="timer-bar" class="timer-bar"></div></div>
            <div class="vinyl-wrapper-sm">
                <div class="vinyl" id="mc-vinyl"><div class="vinyl-label"></div></div>
            </div>
            <button id="mc-play-btn" class="btn btn-primary" style="width:50%; margin: 5px auto;"><i class="fas fa-play"></i> Play</button>
            <p>Welcher Song l√§uft?</p>
            <div id="mc-options" class="mc-grid"></div>
        </div>

        <div id="loader" class="hidden modal-overlay"><div class="spinner"></div><p style="margin-top:10px;">Lade Musik...</p></div>

        <div id="game-over" class="hidden modal-overlay">
            <h1 id="go-title" style="font-size:3rem; margin-bottom:10px;">Game Over</h1>
            <p id="go-msg" style="font-size:1.2rem; margin:20px 0; max-width:80%; line-height:1.5;">Punkte</p>
            <button class="btn btn-primary" onclick="location.reload()">Neues Spiel</button>
        </div>

        <audio id="audio-player"></audio>
    </div>

    <script>
        /* --- STATE & CONFIG --- */
        let state = {
            playlistId: null,
            tracks: [],
            pool: [],
            currentTrack: null,
            isPlaying: false,
            timeline: [],
            lives: 3,
            targetScore: 10,
            score: 0,
            startTime: 0
        };

        const els = {
            audio: document.getElementById('audio-player'),
            tlArea: document.getElementById('timeline-area'),
            mcOptions: document.getElementById('mc-options'),
            timerBar: document.getElementById('timer-bar')
        };

        // --- DEEZER API HELPER (JSONP) ---
        function fetchDeezer(url) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                const cb = 'dz_' + Math.round(Math.random() * 1000000);
                window[cb] = (d) => { delete window[cb]; document.body.removeChild(script); resolve(d); };
                script.src = url + (url.includes('?') ? '&' : '?') + 'output=jsonp&callback=' + cb;
                script.onerror = () => reject();
                document.body.appendChild(script);
            });
        }

        // --- CORE NAVIGATION ---
        function showScreen(id) {
            document.querySelectorAll('.app-container > div').forEach(el => {
                if(!['loader', 'game-over'].includes(el.id)) el.classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden');
        }

        async function searchPlaylists() {
            const q = document.getElementById('search-input').value;
            if(!q) return;
            document.getElementById('playlist-list').innerHTML = 'Suche...';
            try {
                const d = await fetchDeezer(`https://api.deezer.com/search/playlist?q=${encodeURIComponent(q)}`);
                const html = d.data.map(p => `
                    <div class="playlist-item" onclick="selectPlaylist('${p.id}', '${p.title.replace(/'/g,"")}')">
                        <img src="${p.picture_medium}"><div class="playlist-info"><h4>${p.title}</h4><span>${p.nb_tracks} Songs</span></div>
                    </div>`).join('');
                document.getElementById('playlist-list').innerHTML = html;
            } catch(e) { document.getElementById('playlist-list').innerHTML = 'Fehler.'; }
        }
        document.getElementById('search-btn').addEventListener('click', searchPlaylists);

        async function selectPlaylist(id, name) {
            state.playlistId = id;
            document.getElementById('selected-playlist-name').innerText = name;
            document.getElementById('loader').classList.remove('hidden');
            try {
                const d = await fetchDeezer(`https://api.deezer.com/playlist/${id}/tracks?limit=400`);
                // Filter: Nur Songs mit Preview und Album
                state.tracks = d.data.filter(t => t.preview && t.album && t.album.id);
                if(state.tracks.length < 10) throw new Error("Playlist zu klein (min. 10 spielbare Songs)");

                // Shuffle
                state.pool = [...state.tracks].sort(() => 0.5 - Math.random());

                document.getElementById('loader').classList.add('hidden');
                showScreen('screen-mode');
            } catch(e) {
                document.getElementById('loader').classList.add('hidden');
                alert(e.message);
            }
        }

        function setupGame(mode) {
            if(mode === 'timeline') document.getElementById('timeline-settings').classList.remove('hidden');
            else startMC();
        }

        // --- AUDIO ENGINE ---
        function playTrack(url, vinylId, btnId) {
            if(state.isPlaying && els.audio.src === url) {
                els.audio.pause();
                state.isPlaying = false;
                if(vinylId) document.getElementById(vinylId).classList.remove('spinning');
                if(btnId) document.getElementById(btnId).innerHTML = '<i class="fas fa-play"></i>';
            } else {
                els.audio.src = url;
                els.audio.play().catch(e => console.log("Auto-Play blockiert"));
                state.isPlaying = true;
                if(vinylId) document.getElementById(vinylId).classList.add('spinning');
                if(btnId) document.getElementById(btnId).innerHTML = '<i class="fas fa-pause"></i>';
            }
            els.audio.onended = () => {
                state.isPlaying = false;
                if(vinylId) document.getElementById(vinylId).classList.remove('spinning');
                if(btnId) document.getElementById(btnId).innerHTML = '<i class="fas fa-play"></i>';
            };
        }
        function stopAudio() {
            els.audio.pause();
            state.isPlaying = false;
            document.querySelectorAll('.vinyl').forEach(v => v.classList.remove('spinning'));
        }

        /* --- INTELLIGENTE JAHR-ERMITTLUNG (Der Fix) --- */
        function getYearFromISRC(isrc) {
            if (!isrc || isrc.length < 7) return null;
            const yy = parseInt(isrc.substring(5, 7));
            if (isNaN(yy)) return null;
            // 70er, 80er, 90er Check. Wenn YY > (Aktuelles Jahr + 1), dann 19xx.
            // Bsp: 76 (1976) > 26 (2026).
            return (yy > (new Date().getFullYear() % 100) + 1) ? 1900 + yy : 2000 + yy;
        }

        async function getSongDetails(track) {
            try {
                // Parallel Request f√ºr Speed
                const albPromise = fetchDeezer(`https://api.deezer.com/album/${track.album.id}`);
                const trackPromise = track.isrc ? Promise.resolve(track) : fetchDeezer(`https://api.deezer.com/track/${track.id}`);

                const [alb, tDetails] = await Promise.all([albPromise, trackPromise]);

                // Datum aus Album (Format: YYYY-MM-DD)
                let albumYear = parseInt(alb.release_date.split('-')[0]);

                // Datum aus ISRC (Oft das "echte" Aufnahmejahr bei Remasters)
                const isrcYear = getYearFromISRC(tDetails.isrc);

                // Logik: Wenn ISRC √§lter ist als Album (und plausibel > 1900), nimm ISRC.
                // Das fixt "Best Of" Alben aus 2010 mit Songs von 1980.
                let finalYear = albumYear;
                if(isrcYear && isrcYear < albumYear && isrcYear > 1900) finalYear = isrcYear;

                // Sicherheits-Check: Ung√ºltiges Jahr?
                if(isNaN(finalYear) || finalYear < 1900 || finalYear > 2030) throw new Error("Ung√ºltiges Jahr");

                return { ...track, year: finalYear, cover: track.album.cover_medium };
            } catch(e) {
                // Wenn Daten fehlerhaft sind, Song √ºberspringen durch Fehlerwurf
                console.warn("Song √ºbersprungen (Datenfehler):", track.title);
                return null;
            }
        }

        // Hilfsfunktion: Holt so lange Songs, bis einer valid ist
        async function getValidSong() {
            while(state.pool.length > 0) {
                const raw = state.pool.pop();
                const song = await getSongDetails(raw);
                if(song) return song;
            }
            return null;
        }

        /* --- TIMELINE GAME LOGIC --- */
        async function startTimeline(target) {
            state.targetScore = target;
            state.lives = 3;
            state.timeline = [];
            updateLives();
            document.getElementById('tl-target').innerText = target;

            document.getElementById('loader').classList.remove('hidden');
            const start = await getValidSong();
            if(!start) return endGame(true, "Keine spielbaren Songs gefunden.");

            state.timeline.push(start);
            await nextTimelineRound();
            document.getElementById('loader').classList.add('hidden');
            showScreen('screen-game-timeline');
            renderTimeline();
        }

        async function nextTimelineRound() {
            const song = await getValidSong();
            if(!song) return endGame(true, "Playlist leer!");
            state.currentTrack = song;

            // UI Update
            document.querySelector('#tl-vinyl .vinyl-label').style.backgroundImage = `url(${state.currentTrack.cover})`;
            document.getElementById('tl-play-btn').onclick = () => playTrack(state.currentTrack.preview, 'tl-vinyl', 'tl-play-btn');
            playTrack(state.currentTrack.preview, 'tl-vinyl', 'tl-play-btn');
        }

        function renderTimeline() {
            const area = els.tlArea;
            area.innerHTML = ''; // Clear old buttons

            // Logik: Wir brauchen N+1 Buttons f√ºr N Karten.
            // Button 0 (Ganz oben) -> Karte 0 -> Button 1 -> Karte 1 -> ...

            // 1. Oberster Button
            area.appendChild(createInsertBtn(0));

            state.timeline.forEach((song, i) => {
                // Die Karte
                const card = document.createElement('div');
                card.className = 'timeline-card';
                card.innerHTML = `
                    <div style="font-weight:800; color:var(--primary); font-size:1.3rem; min-width:50px;">${song.year}</div>
                    <img src="${song.cover}" style="width:45px; height:45px; border-radius:6px;">
                    <div style="text-align:left; font-size:0.85rem; flex-grow:1; line-height:1.2;">
                        <strong>${song.title}</strong><br><span style="opacity:0.8; font-size:0.75rem;">${song.artist.name}</span>
                    </div>`;
                area.appendChild(card);

                // Button darunter (Index i+1)
                area.appendChild(createInsertBtn(i + 1));
            });
        }

        function createInsertBtn(index) {
            const d = document.createElement('div');
            d.className = 'insert-btn';
            d.innerHTML = 'Hier einf√ºgen';
            d.onclick = () => checkTimeline(index);
            return d;
        }

        function checkTimeline(i) {
            stopAudio();
            const y = state.currentTrack.year;
            // Pr√ºfung: Karte an Index i bedeutet: Sie muss NACH i-1 und VOR i sein.
            const prev = state.timeline[i-1]; // Karte davor (kann undefined sein bei i=0)
            const next = state.timeline[i];   // Karte danach (kann undefined sein bei i=length)

            // Fehlerbedingungen:
            // 1. Es gibt eine Karte davor, aber unser Jahr ist kleiner (√§lter)
            // 2. Es gibt eine Karte danach, aber unser Jahr ist gr√∂√üer (neuer)
            // (Gleiches Jahr ist erlaubt!)
            const errorPrev = prev && y < prev.year;
            const errorNext = next && y > next.year;

            if(errorPrev || errorNext) {
                // Falsch
                state.lives--;
                updateLives();

                // Besseres Feedback
                let msg = `Falsch! Der Song ist von ${y}.`;
                if(errorPrev) msg += `\n(Er ist √§lter als ${prev.year})`;
                else if(errorNext) msg += `\n(Er ist neuer als ${next.year})`;

                alert(msg);

                if(state.lives <= 0) endGame(false, "Keine Leben mehr.");
                else {
                    document.getElementById('loader').classList.remove('hidden');
                    nextTimelineRound().then(() => document.getElementById('loader').classList.add('hidden'));
                }
            } else {
                // Richtig
                state.timeline.splice(i, 0, state.currentTrack); // Einf√ºgen

                if(state.timeline.length >= state.targetScore) {
                    endGame(true, `Gl√ºckwunsch! Du hast ${state.targetScore} Karten korrekt sortiert.`);
                } else {
                    renderTimeline(); // Neu zeichnen mit neuer Karte
                    document.getElementById('loader').classList.remove('hidden');
                    nextTimelineRound().then(() => document.getElementById('loader').classList.add('hidden'));
                }
            }
        }

        function updateLives() {
            document.getElementById('tl-lives').innerText = "‚ù§Ô∏è".repeat(state.lives) + "üñ§".repeat(3-state.lives);
        }

        /* --- HIGHSCORE MC GAME --- */
        function startMC() {
            state.score = 0;
            document.getElementById('mc-score').innerText = 0;
            showScreen('screen-game-mc');
            nextMCRound();
        }

        async function nextMCRound() {
            if(state.pool.length < 4) return endGame(true, `Playlist leer! Score: ${state.score}`);

            const targetRaw = state.pool.pop();
            const target = await getSongDetails(targetRaw); // Ensure clean data
            if(!target) return nextMCRound(); // Skip invalid

            // Decoys suchen
            const decoys = [];
            let safety = 0;
            while(decoys.length < 3 && safety < 100) {
                safety++;
                const d = state.pool[Math.floor(Math.random() * state.pool.length)];
                if(d.id !== target.id && !decoys.find(x => x.id === d.id)) decoys.push(d);
            }
            if(decoys.length < 3) return endGame(true, `Zu wenig Songs √ºbrig. Score: ${state.score}`);

            state.currentTrack = target;

            // UI Reset
            stopAudio();
            const vLabel = document.querySelector('#mc-vinyl .vinyl-label');
            vLabel.style.backgroundImage = 'none';
            vLabel.style.backgroundColor = '#333';

            document.getElementById('mc-play-btn').onclick = () => playTrack(state.currentTrack.preview, 'mc-vinyl', 'mc-play-btn');
            playTrack(state.currentTrack.preview, 'mc-vinyl', 'mc-play-btn');

            // Render Buttons
            const options = [target, ...decoys].sort(() => 0.5 - Math.random());
            els.mcOptions.innerHTML = '';
            options.forEach(o => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-secondary mc-btn';
                btn.innerText = o.title;
                btn.onclick = () => checkMC(btn, o.id === target.id);
                els.mcOptions.appendChild(btn);
            });

            // Start Timer
            els.timerBar.classList.remove('animate-timer');
            void els.timerBar.offsetWidth; // Force Reflow
            els.timerBar.classList.add('animate-timer');
            state.startTime = Date.now();
        }

        function checkMC(btn, isCorrect) {
            stopAudio();
            els.timerBar.style.animationPlayState = 'paused';
            document.querySelector('#mc-vinyl .vinyl-label').style.backgroundImage = `url(${state.currentTrack.cover})`;

            if(isCorrect) {
                // Score Calculation
                const ms = Date.now() - state.startTime;
                // Max 1000 Punkte, Minimum 100. Zeitfenster 30s.
                // 1000 - (30pkt pro Sekunde)
                let pts = Math.max(100, Math.floor(1000 - (ms / 30)));

                state.score += pts;
                document.getElementById('mc-score').innerText = state.score;

                btn.classList.replace('btn-secondary', 'btn-success');
                showFloatingPoints(pts);

                setTimeout(nextMCRound, 1500);
            } else {
                btn.classList.replace('btn-secondary', 'btn-danger');
                // Zeige Richtige
                Array.from(els.mcOptions.children).forEach(b => {
                    if(b.innerText === state.currentTrack.title) b.classList.add('btn-success');
                });
                setTimeout(() => endGame(false, `Falsch! Highscore: ${state.score}`), 2000);
            }
        }

        function showFloatingPoints(pts) {
            const el = document.createElement('div');
            el.className = 'score-change';
            el.innerText = `+${pts}`;
            document.getElementById('screen-game-mc').appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        // --- GLOBAL END ---
        function endGame(win, msg) {
            stopAudio();
            document.getElementById('go-title').innerText = win ? "Sieg!" : "Game Over";
            document.getElementById('go-title').style.color = win ? "#2ecc71" : "#e74c3c";
            document.getElementById('go-msg').innerText = msg;
            document.getElementById('game-over').classList.remove('hidden');
        }
    </script>
</body>
</html>
